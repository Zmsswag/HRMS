{% extends 'myapp/base.html' %}
{% load static %}

{% block title %}添加新员工 - 综合人力资源信息处理系统{% endblock %}

{% block extra_css %}
  <!-- 可以复用编辑页面的CSS，或者创建新的 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{% static 'myapp/css/employee_edit.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div id="app" v-cloak>
    <!-- 返回按钮 -->
    <div class="back-button mb-3">
      <a href="{% url 'employee_list' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> 返回员工列表
      </a>
    </div>

    <div v-if="loading" class="text-center my-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">加载中...</span>
      </div>
      <p>正在加载表单数据...</p>
    </div>
    
    <div v-else>
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>添加新员工</h1>
      </div>
      
      <div v-if="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
        [[ successMessage ]]
        <button type="button" class="btn-close" @click="successMessage = ''" aria-label="Close"></button>
      </div>
      
      <div v-if="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
        [[ errorMessage ]]
        <button type="button" class="btn-close" @click="errorMessage = ''" aria-label="Close"></button>
      </div>
      
      <form @submit.prevent="createEmployee">
        {% csrf_token %}
        <!-- 基本信息 -->
        <div class="card mb-4">
          <div class="card-header">基本信息</div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="employeeId" class="form-label">员工工号 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="employeeId" v-model="newEmployee.employee_id" required>
              </div>
              <div class="col-md-6">
                <label for="name" class="form-label">姓名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="name" v-model="newEmployee.name" required>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="idNumber" class="form-label">身份证号</label>
                <input type="text" class="form-control" id="idNumber" v-model="newEmployee.id_number">
              </div>
              <div class="col-md-6">
                <label for="age" class="form-label">年龄 <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="age" v-model="newEmployee.age" required>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="hireDate" class="form-label">入职日期 <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="hireDate" v-model="newEmployee.hire_date" required>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 部门和职位信息 -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>部门和职位信息 <span class="text-danger">*</span></span>
            <button type="button" class="btn btn-sm btn-primary" @click="addDepartmentPosition">
                <i class="bi bi-plus-lg"></i> 添加部门职位
            </button>
          </div>
          <div class="card-body">
            <div v-if="departmentPositions.length === 0" class="text-muted p-3 text-center">
              请点击上方按钮添加员工的部门和职位
            </div>
            <div v-else>
              <div v-for="(dp, index) in departmentPositions" :key="index" class="row mb-3 align-items-end">
                <div class="col-md-5">
                  <label :for="'department'+index" class="form-label">部门</label>
                  <select class="form-select" :id="'department'+index" v-model="dp.department_id" @change="updatePositionOptions(index)" required>
                    <option value="" disabled selected>请选择部门</option>
                    <option v-for="dept in departments" :key="dept.id" :value="dept.id">[[ dept.name ]]</option>
                  </select>
                </div>
                <div class="col-md-5">
                  <label :for="'position'+index" class="form-label">职位</label>
                  <select class="form-select" :id="'position'+index" v-model="dp.position_id" required>
                    <option value="" disabled selected>请选择职位</option>
                    <option v-for="pos in getPositionsForDepartment(dp.department_id)" :key="pos.id" :value="pos.id">[[ pos.title ]]</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button type="button" class="btn btn-danger" @click="removeDepartmentPosition(index)">
                    <i class="bi bi-trash"></i> 删除
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="d-flex justify-content-between">
          <a href="{% url 'employee_list' %}" class="btn btn-secondary">取消</a>
          <button type="submit" class="btn btn-primary">创建员工</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Vue.js and Axios -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // 从cookie获取CSRF令牌
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  const csrftoken = getCookie('csrftoken');
  axios.defaults.headers.common['X-CSRFToken'] = csrftoken;
  
  new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    data: {
      newEmployee: {
        employee_id: '',
        name: '',
        id_number: '',
        age: '',
        hire_date: new Date().toISOString().slice(0, 10), // 默认今天
      },
      departments: [],
      positions: [],
      departmentPositions: [],
      loading: true,
      successMessage: '',
      errorMessage: ''
    },
    mounted() {
      // 获取创建员工所需的部门和职位列表
      axios.get(`{% url 'employee_add' %}?format=json`)
        .then(response => {
          const data = response.data;
          this.departments = data.departments;
          this.positions = data.positions;
          this.loading = false;
        })
        .catch(error => {
          this.errorMessage = '加载表单数据失败: ' + (error.response?.data?.error || error.message);
          this.loading = false;
        });
    },
    methods: {
      getPositionsForDepartment(departmentId) {
        if (!departmentId) return [];
        return this.positions.filter(pos => pos.department_id == departmentId);
      },
      updatePositionOptions(index) {
        this.departmentPositions[index].position_id = '';
      },
      addDepartmentPosition() {
        this.departmentPositions.push({
          department_id: '',
          position_id: ''
        });
      },
      removeDepartmentPosition(index) {
        this.departmentPositions.splice(index, 1);
      },
      createEmployee() {
        // 清除旧消息
        this.successMessage = '';
        this.errorMessage = '';

        // 表单验证
        if (this.departmentPositions.length === 0) {
          this.errorMessage = '请至少为员工添加一个部门和职位';
          return;
        }
        for (const dp of this.departmentPositions) {
          if (!dp.department_id || !dp.position_id) {
            this.errorMessage = '请为每个部门选择对应的职位';
            return;
          }
        }
        
        // 准备提交的数据
        const formData = {
          ...this.newEmployee,
          department_ids: this.departmentPositions.map(dp => dp.department_id),
          position_ids: this.departmentPositions.map(dp => dp.position_id)
        };
        
        // 发送POST请求
        axios.post(`{% url 'employee_add' %}`, formData)
          .then(response => {
            if (response.data.success) {
              this.successMessage = response.data.message || '员工创建成功！';
              const newEmployeeId = response.data.employee_id;
              
              // 3秒后跳转到新员工的详情页
              setTimeout(() => {
                window.location.href = `/employee/${newEmployeeId}/`;
              }, 3000);
            } else {
              this.errorMessage = response.data.error || '创建失败，请重试';
            }
          })
          .catch(error => {
            this.errorMessage = '创建员工时发生错误: ' + (error.response?.data?.error || error.message);
          });
      }
    }
  });
</script>
{% endblock %}